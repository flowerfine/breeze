version: "3.1"

services:

  scaleph-api:
    image: scaleph/scaleph-api:0.0.1-SNAPSHOT
    container_name: scaleph-api
    depends_on:
      - mysql
      - redis
      - minio
    build:
      dockerfile: ../../../scaleph-api/Dockerfile
      context: ../../../scaleph-api
    ports:
      - 8080:8080
    networks:
      - scaleph

  scaleph-ui:
    image: scaleph/scaleph-ui:latest
    container_name: scaleph-ui
    depends_on:
      - scaleph-api
    ports:
      - 80:80
    networks:
      - scaleph

  mysql:
    image: bitnami/mysql:8.0
    container_name: mysql
    environment:
      - TZ=Asia/Shanghai
      - MYSQL_ROOT_USER=root
      - MYSQL_ROOT_PASSWORD=123456
      - MYSQL_AUTHENTICATION_PLUGIN=mysql_native_password
      - MYSQL_DATABASE=scaleph
    ports:
      - 3306:3306
    volumes:
      - ../mysql/my_custom.cnf:/opt/bitnami/mysql/conf/my_custom.cnf
      - ../mysql/init.d:/docker-entrypoint-initdb.d
    networks:
      - scaleph

  redis:
    image: bitnami/redis:6.0
    container_name: redis
    environment:
      - REDIS_PORT_NUMBER=6379
      - REDIS_PASSWORD=123456
    ports:
      - 6379:6379
    networks:
      - scaleph

  minio:
    image: bitnami/minio:2022
    container_name: minio
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password
      - MINIO_DEFAULT_BUCKETS=scaleph
    ports:
      - 9000:9000
      - 9001:9001

  jobmanager:
    image: flink:1.13.6-scala_2.12-java8
    container_name: jobmanager
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: jobmanager
    ports:
      - 8081:8081
    command: jobmanager
    networks:
      - scaleph

  taskmanager:
    image: flink:1.13.6-scala_2.12-java8
    container_name: taskmanager
    depends_on:
      - jobmanager
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 8
    command: taskmanager
    scale: 1
    networks:
      - scaleph

  zookeeper:
    image: bitnami/zookeeper:3.7.0
    container_name: zookeeper
    ports:
      - 2181:2181
    environment:
      - TZ=Asia/Shanghai
      - ALLOW_ANONYMOUS_LOGIN=yes
    restart: unless-stopped
    networks:
      - scaleph

  kafka:
    image: bitnami/kafka:2.2.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - 9092:9092
      - 9093:9093
    environment:
      - KAFKA_BROKER_ID=1
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_LISTENERS=CLIENT://:9092,EXTERNAL://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=CLIENT://kafka:9092, EXTERNAL://localhost:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CLIENT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=CLIENT
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
    restart: unless-stopped
    networks:
      - scaleph

  canal-server:
    image: canal/canal-server:v1.1.5
    container_name: canal-server
    depends_on:
      - mysql
      - kafka
    ports:
      - 11111:11111
    volumes:
      - ../canal/canal.properties:/home/admin/canal-server/conf/canal.properties
      - ../canal/instance.properties:/home/admin/canal-server/conf/data_pipe/instance.properties
    restart: unless-stopped
    networks:
      - scaleph

networks:
  scaleph:
    driver: bridge